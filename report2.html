<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v2.1 - Dashboard de Campanhas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding: 20px; }
    .card-total { font-size: 1.4rem; font-weight: bold; }
    canvas { max-height: 300px; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; font-size: 1.5rem; font-weight: 600; color: #E55500; }
    .choices__inner { min-height: 45px; max-height: 120px; overflow-y: auto; }
    .choices__list--multiple .choices__item { white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 140px; background-color: #E55500; border: none;}
    #btnExportar { background-color: #d32f2f; border: none; color: white; }
    #btnExportar:hover { background-color: #b71c1c; }
  </style>
</head>
<body>
<div id="loading"><div class="d-flex align-items-center"><div class="spinner-border text-warning" role="status"></div><span>Carregando dados...</span></div></div>
<div class="container" style="display:none" id="conteudo">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 id="tituloRelatorio">Resultados</h3>
    <div id="areaExportar">
        <button id="btnExportar" class="btn"><i class="fas fa-file-pdf me-2"></i>Exportar para PDF</button>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card p-3">
        <div>Total de Respostas</div>
        <div class="card-total" id="totalRespostas">0</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <div>NPS</div>
        <div class="card-total" id="npsPeriodo">0.00</div>
      </div>
    </div>
  </div>
  <h4>游늶 Estrat칠gias de P치ginas de Captura <small>(Todo Per칤odo)</small></h4>
  <div class="table-responsive mb-5">
    <table class="table table-bordered table-hover" id="tabelaPaginas">
      <thead>
        <tr>
          <th>Nome da Loja</th>
          <th>Nome da P치gina</th>
          <th>Tipo da P치gina</th>
          <th>Qtd de Acessos</th>
          <th>Qtd de Capturas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <h4>游늶 Pesquisas realizadas <small>(Todo Per칤odo)</small></h4>
  <div class="table-responsive">
    <table class="table table-bordered table-hover" id="tabelaPesquisas">
      <thead>
        <tr>
          <th>Nome da Loja</th>
          <th>Nome da Pesquisa</th>
          <th>Qtd de Respostas</th>
          <th>NPS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
const params = new URLSearchParams(window.location.search);
const rawUserId = params.get('userId') || "";
const userId = rawUserId.replace('1092EZT3', '');
if (!userId) {
  alert("ID do usu치rio inv치lido.");
  throw new Error("ID de usu치rio inv치lido");
}

const endpointPaginas = `https://api.fabrica.app/user/queries/pagesbyuser?userId=${userId}`;
const endpointPesquisas = `https://api.fabrica.app/user/queries/surveybyuser?userId=${userId}`;

fetch(endpointPaginas)
  .then(res => res.json())
  .then(data => preencherTabelaPaginas(data))
  .catch(error => {
    console.error('Erro ao buscar dados da API:', error);
    document.getElementById('loading').innerText = 'Erro ao carregar dados';
  });

function preencherTabelaPaginas(data) {
  const tbody = document.querySelector('#tabelaPaginas tbody');
  tbody.innerHTML = '';
  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.nome_loja}</td>
      <td>${p.nome_pagina}</td>
      <td>${p.tipo_pagina}</td>
      <td>${p.qtd_visualizacoes}</td>
      <td>${p.qtd_capturas}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('loading').style.display = 'none';
  document.getElementById('conteudo').style.display = 'block';
}

fetch(endpointPesquisas)
  .then(res => res.json())
  .then(data => preencherTabelaPesquisas(data))
  .catch(error => {
    console.error('Erro ao buscar pesquisas:', error);
  });

function preencherTabelaPesquisas(data) {
  const tbody = document.querySelector('#tabelaPesquisas tbody');
  tbody.innerHTML = '';
  let totalRespostas = 0;
  let somaNPS = 0;
  let lojasComNPS = 0;

  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.nome_loja}</td>
      <td>${p.nome_pesquisa}</td>
      <td>${p.total_respostas}</td>
      <td>${parseFloat(p.nps).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);

    totalRespostas += parseInt(p.total_respostas);
    if (!isNaN(parseFloat(p.nps))) {
      somaNPS += parseFloat(p.nps);
      lojasComNPS++;
    }
  });

  const mediaNPS = lojasComNPS > 0 ? somaNPS / lojasComNPS : 0;
  document.getElementById('totalRespostas').textContent = totalRespostas;
  document.getElementById('npsPeriodo').textContent = mediaNPS.toFixed(2);
}
</script>
</body>
</html>
